import{i as _,r as s,j as e,_ as $,B as E}from"./index-B9lI-E5Z.js";import{r as z,u as M}from"./xlsx-CygJKsBP.js";import{E as H}from"./ExpandMore-BJ3YRxU1.js";import{A as q,a as G,b as K}from"./AccordionSummary-Db-BoziI.js";import{T as N}from"./Typography-ZiHRPRGe.js";import{T as m}from"./TextField-pkXCnTMa.js";import{B as A}from"./Button-ec8HoK58.js";import"./Grow-Xg_gaWHI.js";import"./Paper-B0Ue3MgX.js";import"./index-BzYBUyx_.js";import"./extendSxProp-B9T1A6Fe.js";import"./Select-pFCojNNd.js";import"./Menu-CCmO_UM8.js";import"./index-5OMxfQPG.js";import"./mergeSlotProps-Ddvu8BZc.js";function de(){const{testId:j}=_(),[I,v]=s.useState(""),[i,u]=s.useState([]),[S,C]=s.useState(""),[y,T]=s.useState(""),[b,k]=s.useState(""),[p,r]=s.useState({sent:0,failed:0,total:0}),[l,o]=s.useState(!1),[f,O]=s.useState(!1),c=s.useRef(null),P=t=>{v(t.target.value);try{const a=JSON.parse(t.target.value);Array.isArray(a)&&(u(a.map(d=>d.trim().toLowerCase())),r({sent:0,failed:0,total:a.length}))}catch{u([]),r({sent:0,failed:0,total:0})}},F=t=>{const a=t.target.files[0];if(!a)return;const d=new FileReader;d.onload=R=>{const D=new Uint8Array(R.target.result),w=z(D,{type:"array"}),L=w.SheetNames[0],U=w.Sheets[L],h=M.sheet_to_json(U,{defval:""});let x=null;if(h.length>0&&(x=Object.keys(h[0]).find(W=>["email","Email","EMAIL","E-mail"].includes(W))),!x){alert("Could not find an email column named 'email' in Excel file");return}const g=h.map(n=>n[x]).filter(n=>n).map(n=>n.toString().trim().toLowerCase());u(g),v(JSON.stringify(g,null,2)),r({sent:0,failed:0,total:g.length})},d.readAsArrayBuffer(a)},B=async()=>{if(!i.length){alert("Please provide emails via JSON input or Excel upload.");return}o(!0),r(t=>({...t,failed:0}));try{const t=await fetch(`${E}/api/admin/campus-test/${j}/send-mails`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({emails:i,testDate:S,testTime:y,basicInfo:b})}),a=await t.json();if(!t.ok)throw new Error(a.message||"Failed to start sending");c.current=setInterval(J,3e3)}catch(t){alert(t.message),o(!1)}},J=async()=>{try{const a=await(await fetch(`${E}/api/admin/campus-test/${j}/email-status`,{credentials:"include"})).json();a.completed&&(clearInterval(c.current),o(!1),alert("Email sending completed!")),r(a)}catch{clearInterval(c.current),o(!1),alert("Failed to fetch status")}};return s.useEffect(()=>()=>clearInterval(c.current),[]),e.jsxs("div",{className:"max-w-3xl mx-auto p-4 space-y-6",children:[e.jsxs(q,{children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsx(N,{className:"font-semibold",children:"Accepted Input Formats"})}),e.jsx(K,{children:e.jsxs(N,{children:[e.jsx("b",{children:"JSON Array"}),": Paste a JSON array of emails into the textarea below.",e.jsx("br",{}),"Example: ",e.jsx("code",{children:'["email1@example.com", "email2@example.com"]'}),e.jsx("br",{}),e.jsx("br",{}),e.jsx("b",{children:"Excel (.xlsx) file"}),": Upload an Excel file with one column named"," ",e.jsx("code",{children:"email"})," (case-insensitive)."]})})]}),e.jsx(m,{label:"Paste JSON array of emails",multiline:!0,minRows:5,value:I,onChange:P,disabled:l,fullWidth:!0,variant:"outlined",placeholder:'Example: ["email1@example.com", "email2@example.com"]'}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 font-semibold text-gray-700",children:'Or upload Excel (.xlsx) file with "email" column:'}),e.jsx("input",{type:"file",accept:".xlsx",onChange:F,disabled:l,className:"border rounded p-2 w-full"})]}),e.jsx(m,{label:"Test Date",value:S,onChange:t=>C(t.target.value),disabled:l,fullWidth:!0,variant:"outlined"}),e.jsx(m,{label:"Test Time",value:y,onChange:t=>T(t.target.value),disabled:l,fullWidth:!0,variant:"outlined"}),e.jsx(m,{label:"Additional Basic Info",multiline:!0,minRows:3,value:b,onChange:t=>k(t.target.value),disabled:l,fullWidth:!0,variant:"outlined",placeholder:"Additional information to include in email"}),e.jsx(A,{variant:"contained",color:"primary",onClick:B,disabled:l||i.length===0,className:"w-full py-3 mt-4",size:"large",children:l?e.jsxs(e.Fragment,{children:["Sending Emails... ",e.jsx($,{size:20,className:"ml-2"})]}):"Start Sending Emails"}),e.jsxs(A,{onClick:()=>O(!f),className:"mt-4 text-blue-600 hover:underline",children:[f?"Hide":"Show"," Email Preview (",i.length,")"]}),f&&e.jsx("div",{className:"max-h-64 overflow-y-auto bg-gray-50 border border-gray-300 rounded p-4 font-mono whitespace-pre-wrap mt-2",children:i.length>0?i.map((t,a)=>e.jsx("div",{children:t},a)):e.jsx("div",{children:"No emails to preview"})}),e.jsxs("div",{className:"mt-6 text-center text-lg font-semibold",children:["Sent: ",e.jsx("span",{className:"text-green-600",children:p.sent})," / ",p.total," | Failed:"," ",e.jsx("span",{className:"text-red-600",children:p.failed})]})]})}export{de as default};

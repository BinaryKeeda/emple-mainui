import{a as P,i as V,q as W,r as i,d as w,M as K,j as e,L as T,I as X,o as Z,ab as L,B as S}from"./index-D-BX825n.js";import{M as ee}from"./Menu-Dd3bPqGl.js";import{T as se}from"./TextField-BafRqoij.js";import{D as te}from"./Drawer-Cio24Mpp.js";import{B as re}from"./Box-C-4ojVba.js";import{B as ae}from"./Button-j4t6CXUy.js";import"./Select-thYTgGZV.js";import"./Menu-BwkM7v5c.js";import"./index-C2VwFV7G.js";import"./Grow-QxDGGO1L.js";import"./Paper-BclVFx11.js";import"./mergeSlotProps-BGYDMT9x.js";import"./index-ClycMg3H.js";import"./extendSxProp-CtZMy0B4.js";const je=()=>{const{user:p}=P(s=>s.auth),{slug:x}=V(),C=W(),[o,U]=i.useState(null),[h,I]=i.useState(null),[g,B]=i.useState([]),[d,b]=i.useState({}),[v,_]=i.useState(new Set),[c,f]=i.useState(0),[$,k]=i.useState(0),[D,M]=i.useState(!1),[R,q]=i.useState(!1),[O,j]=i.useState(!1),[F,N]=i.useState(!1),z=i.useRef(d);z.current=d;const t=o==null?void 0:o.questions[c],y=s=>{var r;return((r=s==null?void 0:s.options)==null?void 0:r.filter(a=>a.isCorrect).length)>1},Q=(s,r)=>{const a=s._id;y(s)?b(l=>{const n=new Set(l[a]||[]);return n.has(r)?n.delete(r):n.add(r),{...l,[a]:Array.from(n)}}):b(l=>({...l,[a]:r}))},Y=(s,r)=>{b(a=>({...a,[s]:r}))},G=s=>{var m;const r=((m=g[c])==null?void 0:m._id)===s,a=d[s]&&(Array.isArray(d[s])?d[s].length>0:d[s]),l=v.has(s);let n="p-2 border text-sm";return r?`${n} bg-blue-600 text-white border-blue-700`:a?`${n} bg-green-600/20 border-green-400 text-green-800`:l?`${n} bg-orange-100 border-orange-400 text-orange-800`:`${n} bg-blue-100 border-blue-400 text-blue-600`};i.useEffect(()=>{(async()=>{var r,a;try{const n=(a=(r=(await w.post(`${S}/graphql`,{query:`
              query getUserSolution($slug: String!, $userId: String!) {
                getUserSolution(slug: $slug, userId: $userId) {
                  solution { _id createdAt }
                  quiz {
                    _id
                    duration
                    questions { _id question image marks category negative options { text image isCorrect } }
                  }
                }
              }
            `,variables:{slug:x,userId:p._id}},{withCredentials:!0})).data)==null?void 0:r.data)==null?void 0:a.getUserSolution;if(!n)throw new Error("Invalid response");if(U(n.quiz),B(n.quiz.questions),n.solution)I(n.solution);else{const u=await w.post(`${S}/graphql`,{query:`
                mutation createSolution($quizId: ID!, $userId: ID!) {
                  createSolution(quizId: $quizId, userId: $userId) {
                    _id
                    createdAt
                  }
                }
              `,variables:{quizId:n.quiz._id,userId:p._id}},{withCredentials:!0});I(u.data.data.createSolution)}const m=localStorage.getItem(`solution-${x}`);if(m){const u=JSON.parse(m);b(u.answers||{}),_(new Set(u.visited||[])),f(u.currentIndex||0)}}catch(l){console.error("Failed to fetch quiz",l),C("/user")}})()},[x,p._id,C]),i.useEffect(()=>{t!=null&&t._id&&_(s=>new Set(s).add(t._id))},[c,t]),i.useEffect(()=>{o&&localStorage.setItem(`solution-${x}`,JSON.stringify({answers:d,visited:Array.from(v),currentIndex:c}))},[d,v,c,o,x]),i.useEffect(()=>{if(!o||!h)return;(async()=>{try{const a=Date.now(),l=await w.get(`${S}/api/test/campus/time`,{withCredentials:!0}),n=Date.now();let m=l.data.serverTime;m+=(n-a)/2;const u=new Date(parseInt(h.createdAt)).getTime(),H=parseInt(o.duration)*60*1e3,J=m-u;k(Math.max(H-J,0))}catch(a){console.error("Server time sync failed:",a)}})();const r=setInterval(()=>{k(a=>a<=1e3?(clearInterval(r),A(z.current),0):a-1e3)},1e3);return()=>clearInterval(r)},[o,h]);const A=async(s=d)=>{if(h){M(!0),q(!0);try{await w.post(`${K}/api/v4/eval/quiz/submit`,{quizId:o==null?void 0:o._id,userId:p._id,response:s,submissionId:h._id},{withCredentials:!0}),localStorage.removeItem(`solution-${x}`)}catch(r){console.error("Submission failed",r),q(!1)}finally{M(!1)}}},E=()=>e.jsxs("div",{className:"flex flex-col gap-10 p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-4",children:"Question Navigator"}),e.jsx("div",{className:"grid grid-cols-6 gap-2 lg:grid-cols-5",children:o.questions.map((s,r)=>e.jsx("button",{className:`${G(s._id)} rounded-full h-[40px] w-[40px]`,onClick:()=>{f(r),N(!1)},children:r+1},s._id))})]}),e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsxs("div",{className:"mt-6 text-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-700 inline-block rounded-sm"})," ","Current"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-green-100 border border-green-400 inline-block rounded-sm"})," ","Attempted"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-orange-100 border border-orange-400 inline-block rounded-sm"})," ","Seen"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-100 border border-blue-400 inline-block rounded-sm"})," ","Unseen"]})]}),e.jsx(ae,{fullWidth:!0,onClick:()=>j(!0),variant:"contained",color:"primary",className:"mt-6",children:"Submit"})]})]});return o?e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"relative top-0 left-0 w-full p-4 shadow-sm bg-white z-20 flex justify-between items-center h-[60px]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{onClick:()=>N(!0),className:"lg:hidden","aria-label":"open sidebar",children:e.jsx(ee,{})}),e.jsx("img",{src:Z,className:"h-10",alt:"Logo"})]}),e.jsxs("span",{children:[String(Math.floor($/6e4)).padStart(2,"0"),"m :"," ",String(Math.floor($%6e4/1e3)).padStart(2,"0"),"s"]})]}),e.jsxs("main",{className:"flex bg-white flex-col lg:flex-row h-[calc(100vh-60px)] pt-[0px]",children:[e.jsxs("section",{className:"flex-1 p-5 flex flex-col justify-between",children:[e.jsxs("div",{className:"border p-8 rounded-sm shadow-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("p",{className:"mb-6 text-base",children:["Q",c+1,"."," ",e.jsx("span",{style:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:t==null?void 0:t.question}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"bg-green-100 border-green-400 border p-1 w-[40px] text-xs",children:[" + ",t.marks]}),e.jsx("span",{className:"bg-red-100 border-red-400 border p-1 w-[40px] text-center text-xs",children:t.negative})]})]}),(t==null?void 0:t.image)&&e.jsx("img",{className:"h-60 mb-4",src:t==null?void 0:t.image,alt:""}),e.jsxs("div",{className:"space-y-4",children:[(t==null?void 0:t.category)!="Text"?t.options.map((s,r)=>{var n;const a=t._id,l=y(t)?(n=d[a])==null?void 0:n.includes(s.text):d[a]===s.text;return e.jsxs("label",{className:`flex items-center p-3 border rounded-md cursor-pointer transition ${l?"border-blue-600 bg-blue-50":"border-gray-300"}`,children:[e.jsx("input",{type:y(t)?"checkbox":"radio",className:"mr-3",name:`question-${a}`,value:s.text,checked:l,onChange:()=>Q(t,s.text)}),e.jsx("span",{children:s.text})]},r)}):e.jsx(se,{label:"Your Answer",fullWidth:!0,value:d[t._id]||"",onChange:s=>Y(t._id,s.target.value)}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{b(s=>{const r={...s};return delete r[t._id],r})},className:"text-sm text-gray-700",children:"Clear choice"})})]})]}),e.jsxs("div",{className:"mt-8 flex gap-4 justify-end",children:[e.jsx("button",{onClick:()=>f(s=>Math.max(s-1,0)),disabled:c===0,className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Previous"}),c===g.length-1?e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Submit"}):e.jsx("button",{onClick:()=>f(s=>Math.min(s+1,g.length-1)),disabled:c===g.length-1,className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Next"})]})]}),e.jsx("section",{className:"hidden lg:flex lg:w-1/4 border-l border-gray-200",children:e.jsx(E,{})}),e.jsx(te,{anchor:"left",open:F,onClose:()=>N(!1),children:e.jsx(re,{sx:{width:300,p:2},children:e.jsx(E,{})})})]}),e.jsx(L,{open:R,children:e.jsx("div",{className:"relative top-[50%] left-[50%] p-6 w-2/5 min-w-[80%] md:min-w-[40%]    rounded-lg bg-white shadow-lg",style:{transform:"translate(-50%, -50%)"},children:D?e.jsx(T,{}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center pb-4 text-xl font-semibold text-slate-800",children:"Quiz Queued Successfully"}),e.jsx("div",{className:"border-t border-slate-200 py-4 text-slate-600 font-light leading-relaxed",children:"Your quiz has been successfully queued for evaluation. You will be notified once the evaluation is complete."}),e.jsx("div",{className:"flex items-center justify-end pt-4",children:e.jsx("button",{className:"rounded-md border border-transparent py-2 px-4 text-sm text-slate-600 hover:bg-slate-100",onClick:()=>window.location.reload(),children:"Done"})})]})})}),e.jsx(L,{open:O,onClose:()=>j(!1),children:e.jsxs("div",{className:"relative top-[50%] left-[50%] p-6 w-2/5 min-w-[80%] md:min-w-[40%]  rounded-lg bg-white shadow-lg",style:{transform:"translate(-50%, -50%)"},children:[e.jsx("div",{className:"flex shrink-0 items-center pb-4 text-xl font-medium text-slate-800",children:"Are you sure you want to submit?"}),e.jsxs("div",{className:"border-t border-slate-200 py-4 leading-normal text-slate-600 font-light",children:["This action is"," ",e.jsx("span",{className:"font-semibold text-red-600",children:"irreversible"}),". Once submitted, your changes cannot be undone."]}),e.jsxs("div",{className:"flex shrink-0 flex-wrap items-center pt-4 justify-end",children:[e.jsx("button",{onClick:()=>j(!1),className:"rounded-md border border-transparent py-2 px-4 text-center text-sm text-slate-600 hover:bg-slate-100",children:"Cancel"}),e.jsx("button",{onClick:()=>A(),className:"rounded-md bg-green-600 py-2 px-4 border border-transparent text-center text-sm text-white ml-2",children:"Confirm"})]})]})})]}):e.jsx("div",{className:"h-screen flex justify-center items-center",children:e.jsx(T,{})})};export{je as default};

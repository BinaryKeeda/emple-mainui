import{a as K,i as X,q as Z,r as i,d as v,M as Q,j as e,L as U,I as ee,o as se,O as I,B as _}from"./index-BWpwM6wm.js";import{M as te}from"./Menu-f85z5TSm.js";import{T as re}from"./TextField-1nLKWR9i.js";import{D as ae}from"./Drawer-DhkeUWLV.js";import{B as ne}from"./Box-DQ6QhUae.js";import{B as ie}from"./Button-8B6bbq3_.js";import"./Select-quySsUFL.js";import"./Menu-D8sOvZ5z.js";import"./index-B_oAbyRW.js";import"./useSlotProps-CrdNZ0pA.js";import"./Paper-YHM09k75.js";import"./Grow-CmxV9Tds.js";import"./mergeSlotProps-Bx8pxdqr.js";import"./index-BzkhLvT9.js";import"./extendSxProp-BQ-ysKec.js";const Ne=()=>{const{user:f}=K(s=>s.auth),{slug:u}=X(),k=Z(),[l,D]=i.useState(null),[h,$]=i.useState(null),[b,O]=i.useState([]),[o,g]=i.useState({}),[N,M]=i.useState(new Set),[m,p]=i.useState(0),[A,E]=i.useState(0),[R,q]=i.useState(!1),[F,T]=i.useState(!1),[G,j]=i.useState(!1),[H,y]=i.useState(!1),[S,J]=i.useState({open:!1,message:""}),z=i.useRef(o);z.current=o;const t=l==null?void 0:l.questions[m],C=s=>{var r;return((r=s==null?void 0:s.options)==null?void 0:r.filter(a=>a.isCorrect).length)>1},Y=(s,r)=>{const a=s._id;C(s)?g(d=>{const n=new Set(d[a]||[]);return n.has(r)?n.delete(r):n.add(r),{...d,[a]:Array.from(n)}}):g(d=>({...d,[a]:r}))},P=(s,r)=>{g(a=>({...a,[s]:r}))},V=s=>{var c;const r=((c=b[m])==null?void 0:c._id)===s,a=o[s]&&(Array.isArray(o[s])?o[s].length>0:o[s]),d=N.has(s);let n="p-2 border text-sm";return r?`${n} bg-blue-600 text-white border-blue-700`:a?`${n} bg-green-600/20 border-green-400 text-green-800`:d?`${n} bg-orange-100 border-orange-400 text-orange-800`:`${n} bg-blue-100 border-blue-400 text-blue-600`};i.useEffect(()=>{(async()=>{var r,a,d;try{const c=(a=(r=(await v.post(`${_}/graphql`,{query:`
              query getUserSolution($slug: String!, $userId: String!) {
                getUserSolution(slug: $slug, userId: $userId) {
                  solution { _id createdAt }
                  quiz {
                    _id
                    duration
                    questions { _id question image marks category negative options { text image isCorrect } }
                  }
                }
              }
            `,variables:{slug:u,userId:f._id}},{withCredentials:!0})).data)==null?void 0:r.data)==null?void 0:a.getUserSolution;if(!c)throw new Error("Invalid response");if(D(c.quiz),O((d=c.quiz)==null?void 0:d.questions),c.solution)$(c.solution);else{const x=await v.post(`${_}/graphql`,{query:`
                mutation createSolution($quizId: ID!, $userId: ID!) {
                  createSolution(quizId: $quizId, userId: $userId) {
                    _id
                    createdAt
                  }
                }
              `,variables:{quizId:c.quiz._id,userId:f._id}},{withCredentials:!0});$(x.data.data.createSolution)}const w=sessionStorage.getItem(`solution-${u}`);if(w){const x=JSON.parse(w);g(x.answers||{}),M(new Set(x.visited||[])),p(x.currentIndex||0)}}catch(n){console.error(JSON.stringify(n)),J({open:!0,message:"Insufficient Coins"})}})()},[u,f._id,k]),i.useEffect(()=>{t!=null&&t._id&&M(s=>new Set(s).add(t._id))},[m,t]),i.useEffect(()=>{l&&sessionStorage.setItem(`solution-${u}`,JSON.stringify({answers:o,visited:Array.from(N),currentIndex:m}))},[o,N,m,l,u]),i.useEffect(()=>{if(!l||!h)return;(async()=>{try{const a=Date.now(),d=await v.get(`${_}/api/test/campus/time`,{withCredentials:!0}),n=Date.now();let c=d.data.serverTime;c+=(n-a)/2;const w=new Date(parseInt(h.createdAt)).getTime(),x=parseInt(l.duration)*60*1e3,W=c-w;E(Math.max(x-W,0))}catch(a){console.error("Server time sync failed:",a)}})();const r=setInterval(()=>{E(a=>a<=1e3?(clearInterval(r),L(z.current),0):a-1e3)},1e3);return()=>clearInterval(r)},[l,h]);const L=async(s=o)=>{if(h){q(!0),T(!0);try{await v.post(`${Q}/api/v4/eval/quiz/submit`,{quizId:l==null?void 0:l._id,userId:f._id,response:s,submissionId:h._id},{withCredentials:!0}),sessionStorage.removeItem(`solution-${u}`)}catch(r){console.error("Submission failed",r),T(!1)}finally{q(!1)}}},B=()=>e.jsxs("div",{className:"flex flex-col gap-10 p-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-4",children:"Question Navigator"}),e.jsx("div",{className:"grid grid-cols-6 gap-2 lg:grid-cols-5",children:l==null?void 0:l.questions.map((s,r)=>e.jsx("button",{className:`${V(s._id)} rounded-full h-[40px] w-[40px]`,onClick:()=>{p(r),y(!1)},children:r+1},s._id))})]}),e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsxs("div",{className:"mt-6 text-sm space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-700 inline-block rounded-sm"})," ","Current"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-green-100 border border-green-400 inline-block rounded-sm"})," ","Attempted"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-orange-100 border border-orange-400 inline-block rounded-sm"})," ","Seen"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-100 border border-blue-400 inline-block rounded-sm"})," ","Unseen"]})]}),e.jsx(ie,{fullWidth:!0,onClick:()=>j(!0),variant:"contained",color:"primary",className:"mt-6",children:"Submit"})]})]});return!l&&!S.open?e.jsx("div",{className:"h-screen flex justify-center items-center",children:e.jsx(U,{})}):e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"relative top-0 left-0 w-full p-4 shadow-sm bg-white z-20 flex justify-between items-center h-[60px]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ee,{onClick:()=>y(!0),className:"lg:hidden","aria-label":"open sidebar",children:e.jsx(te,{})}),e.jsx("img",{src:se,className:"h-10",alt:"Logo"})]}),e.jsxs("span",{children:[String(Math.floor(A/6e4)).padStart(2,"0"),"m :"," ",String(Math.floor(A%6e4/1e3)).padStart(2,"0"),"s"]})]}),e.jsxs("main",{className:"flex bg-white flex-col lg:flex-row h-[calc(100vh-60px)] pt-[0px]",children:[t&&e.jsx(e.Fragment,{children:e.jsxs("section",{className:"flex-1 p-5 flex flex-col justify-between",children:[e.jsxs("div",{className:"border p-8 rounded-sm shadow-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("p",{className:"mb-6 text-base",children:["Q",m+1,"."," ",e.jsx("span",{style:{whiteSpace:"pre-line"},dangerouslySetInnerHTML:{__html:t==null?void 0:t.question}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"bg-green-100 border-green-400 border p-1 w-[40px] text-xs",children:[" + ",t==null?void 0:t.marks]}),e.jsx("span",{className:"bg-red-100 border-red-400 border p-1 w-[40px] text-center text-xs",children:t==null?void 0:t.negative})]})]}),(t==null?void 0:t.image)&&e.jsx("img",{className:"h-60 mb-4",src:t==null?void 0:t.image,alt:""}),e.jsxs("div",{className:"space-y-4",children:[(t==null?void 0:t.category)!="Text"?t==null?void 0:t.options.map((s,r)=>{var n;const a=t==null?void 0:t._id,d=C(t)?(n=o[a])==null?void 0:n.includes(s==null?void 0:s.text):o[a]===(s==null?void 0:s.text);return e.jsxs("label",{className:`flex items-center p-3 border rounded-md cursor-pointer transition ${d?"border-blue-600 bg-blue-50":"border-gray-300"}`,children:[e.jsx("input",{type:C(t)?"checkbox":"radio",className:"mr-3",name:`question-${a}`,value:s.text,checked:d,onChange:()=>Y(t,s==null?void 0:s.text)}),e.jsx("span",{children:s.text})]},r)}):e.jsx(re,{label:"Your Answer",fullWidth:!0,value:o[t==null?void 0:t._id]||"",onChange:s=>P(t==null?void 0:t._id,s.target.value)}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:()=>{g(s=>{const r={...s};return delete r[t==null?void 0:t._id],r})},className:"text-sm text-gray-700",children:"Clear choice"})})]})]}),e.jsxs("div",{className:"mt-8 flex gap-4 justify-end",children:[e.jsx("button",{onClick:()=>p(s=>Math.max(s-1,0)),disabled:m===0,className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Previous"}),m===b.length-1?e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Submit"}):e.jsx("button",{onClick:()=>p(s=>Math.min(s+1,b.length-1)),disabled:m===b.length-1,className:"px-4 py-2 rounded-md bg-[#1876d2] text-white text-sm disabled:opacity-50",children:"Next"})]})]})}),t&&e.jsx(e.Fragment,{children:e.jsx("section",{className:"hidden lg:flex lg:w-1/4 border-l border-gray-200",children:e.jsx(B,{})})}),e.jsx(ae,{anchor:"left",open:H,onClose:()=>y(!1),children:e.jsx(ne,{sx:{width:300,p:2},children:e.jsx(B,{})})})]}),e.jsx(I,{open:F,children:e.jsx("div",{className:"relative top-[50%] left-[50%] p-6 w-2/5 min-w-[80%] md:min-w-[40%]    rounded-lg bg-white shadow-lg",style:{transform:"translate(-50%, -50%)"},children:R?e.jsx(U,{}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center pb-4 text-xl font-semibold text-slate-800",children:"Quiz Queued Successfully"}),e.jsx("div",{className:"border-t border-slate-200 py-4 text-slate-600 font-light leading-relaxed",children:"Your quiz has been successfully queued for evaluation. You will be notified once the evaluation is complete."}),e.jsx("div",{className:"flex items-center justify-end pt-4",children:e.jsx("button",{className:"rounded-md border border-transparent py-2 px-4 text-sm text-slate-600 hover:bg-slate-100",onClick:()=>window.location.reload(),children:"Done"})})]})})}),e.jsx(I,{open:G,onClose:()=>j(!1),children:e.jsxs("div",{className:"relative top-[50%] left-[50%] p-6 w-2/5 min-w-[80%] md:min-w-[40%]  rounded-lg bg-white shadow-lg",style:{transform:"translate(-50%, -50%)"},children:[e.jsx("div",{className:"flex shrink-0 items-center pb-4 text-xl font-medium text-slate-800",children:"Are you sure you want to submit?"}),e.jsxs("div",{className:"border-t border-slate-200 py-4 leading-normal text-slate-600 font-light",children:["This action is"," ",e.jsx("span",{className:"font-semibold text-red-600",children:"irreversible"}),". Once submitted, your changes cannot be undone."]}),e.jsxs("div",{className:"flex shrink-0 flex-wrap items-center pt-4 justify-end",children:[e.jsx("button",{onClick:()=>j(!1),className:"rounded-md border border-transparent py-2 px-4 text-center text-sm text-slate-600 hover:bg-slate-100",children:"Cancel"}),e.jsx("button",{onClick:()=>L(),className:"rounded-md bg-green-600 py-2 px-4 border border-transparent text-center text-sm text-white ml-2",children:"Confirm"})]})]})}),e.jsx(I,{open:S.open,children:e.jsxs("div",{className:"relative top-[50%] left-[50%] p-6 w-2/5 min-w-[80%] md:min-w-[40%] rounded-lg bg-white shadow-lg",style:{transform:"translate(-50%, -50%)"},children:[e.jsx("div",{className:"flex items-center pb-4 text-xl font-semibold text-red-600",children:"Error"}),e.jsx("div",{className:"border-t border-slate-200 py-4 text-slate-600 leading-relaxed",children:S.message}),e.jsx("div",{className:"flex items-center justify-end pt-4",children:e.jsx("button",{className:"rounded-md bg-red-600 py-2 px-4 text-sm text-white",onClick:()=>k("/user/coins-add"),children:"Go Back Home"})})]})})]})};export{Ne as default};
